#!/usr/bin/perl

use LWP::Simple;

$file = 'mangalist';

if (! -r $file) {
    print "Argh can't read $file!\n";
    exit;
}

open (file, $file);

while (<file>) {
    chomp;
    $manga = $_;
    %info = get_info($manga);

    print_info(\%info);
    print "\n";
}

close (file);

sub get_info {
    $url = $_[0];

    $url =~ m/http:\/\/([^.]*)/;
    $domain = $1;

    if($domain == "mangable") {
        $site = LWP::Simple::get $url;
        return get_mangable_info($url, $site);
    }
}

sub get_mangable_info {
    $url = $_[0];
    $site = $_[1];

    $manga{"site"} = $site;

    if( $site =~ m/<title>(.*?) Manga<\/title>/ ) {
        $manga{"manga"} = $1;
    }

    if( $site =~ m/
            <div\s*id="title">.*?<\/div>
            .*?
            <ul\s*id="list_entry_chapter">
                (.*?)
            <\/ul>
        /xs
    ) {
        $chapters = $1;
        $manga{"chapters"} = $chapters;
    }

    if( $chapters =~ m/<a href="(http:\/\/.*?)" title="(.*?)">/ ) {
        $manga{"link"} = $1;
        $manga{"chapter"} = $2;
    }

    if( $chapters =~ m/<span>(.{3}) (\d{2}), (\d{4})<\/span>/ ) {
        $manga{"date"} = "$1 $2 $3";
    }

    return %manga;
}

sub print_info {
    print "manga:   $_[0]{manga}\n";
    print "link:    $_[0]{link}\n";
    print "chapter: $_[0]{chapter}\n";
    print "date:    $_[0]{date}\n";
}

